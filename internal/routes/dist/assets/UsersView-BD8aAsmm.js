import{u as z,r as ne}from"./services-DL6wjq8D.js";import{u as R}from"./websocket-BtUuRO1W.js";import{a as P,f as T}from"./index-FacjB4mQ.js";import{g as C}from"./errorMessages-Bb-gZ73b.js";import{d as ue,C as de,j as ce,J as v,L as ie,c as V,a as p,l as t,i as s,t as u,x as l,E as i,P as me,k as pe,Q as _e,R as ve,F as fe,r as ge,f as c,H as he,U as ye,I as d,o as F,s as be,_ as ke}from"./index-DbrgNN6k.js";import"./axios-Cl3Sb8ms.js";const we={class:"users-view"},Ce={class:"users-content card"},Ue={class:"search-filter"},xe={class:"filter-buttons"},Se={class:"sort-controls"},ze={class:"sort-label"},Re={key:0,class:"deleting-status"},Fe={class:"total-storage"},Ie=ue({__name:"UsersView",setup(Ee){const{t:e}=de(),I=c(!1),h=c(!1),A=c([]),E=c(!1),f=c({current:1,pageSize:10,total:0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:o=>`共 ${o} 条记录`}),D=c([]),M=c(""),U=c("created_at"),x=c("desc"),y=c(!1),b=c(),k=c(null),B=c(0),n=he({username:"",email:"",password:"",role:"user",active:!0}),L={username:[{required:!0,message:()=>e("users.enterUsername"),trigger:"blur"}],email:[{required:!0,message:()=>e("users.enterEmail"),trigger:"blur"},{type:"email",message:()=>e("users.enterValidEmail"),trigger:"blur"}],password:[{required:!1,message:()=>e("users.enterPassword"),trigger:"blur"},{min:6,message:()=>e("users.passwordLength"),trigger:"blur"}],role:[{required:!0,message:()=>e("users.selectRole"),trigger:"change"}]},j=[{title:"ID",dataIndex:"id",key:"id"},{title:e("users.username"),dataIndex:"username",key:"username"},{title:e("users.email"),dataIndex:"email",key:"email"},{title:e("users.role"),dataIndex:"role",key:"role",slots:{customRender:"role"}},{title:e("users.status"),dataIndex:"active",key:"active",slots:{customRender:"status"}},{title:e("users.imageCount"),dataIndex:"image_count",key:"image_count"},{title:e("users.usedStorage"),key:"total_size",slots:{customRender:"total_size"}},{title:e("users.createdAt"),key:"created_at",slots:{customRender:"created_at"}},{title:e("users.updatedAt"),key:"updated_at",slots:{customRender:"updated_at"}},{title:"操作",key:"actions",slots:{customRender:"actions"}}],g=async()=>{try{I.value=!0;const o=await z.getUsers({page:f.value.current,page_size:f.value.pageSize,searchkey:M.value,orderby:U.value,order:x.value});D.value=o.data.users,f.value.total=o.data.total;for(const r of o.data.users)B.value+=r.total_size||0}catch(o){const r=o.response?.data?.code,_=r?C(r):e("users.fetchFailed");v.error(_)}finally{I.value=!1}},H=o=>{M.value=o,f.value.current=1,g()},J=()=>{M.value="",U.value="created_at",x.value="desc",f.value.current=1,g()},$=()=>{f.value.current=1,g()},K=o=>{f.value=o,g()},Q=o=>{k.value=o,n.username=o.username,n.email=o.email,n.role=o.role.name,n.active=o.active,y.value=!0},W=o=>{ye.confirm({title:e("users.confirmDelete"),content:e("users.deleteContent"),onOk:async()=>{try{h.value=!0,z.deleteUser(o),v.warning(e("users.deleteStarted"))}catch(r){const _=r.response?.data?.code,m=_?C(_):e("users.deleteFailed");v.error(m),h.value=!1}}})},G=async()=>{if(b.value)try{await b.value.validate(),k.value?(await z.updateUser(k.value.id,n),v.success(e("users.updateSuccess"))):(await z.createUser(n),v.success(e("users.createSuccess"))),q(),g()}catch(o){const r=o.response?.data?.code,_=r?C(r):e("users.saveFailed");v.error(_)}},q=()=>{y.value=!1,k.value=null,n.username="",n.email="",n.password="",n.role="user",n.active=!0,b.value&&b.value.resetFields()},X=async()=>{try{E.value=!0;const o=await ne.getRoles({page:1,page_size:100});A.value=o.data}catch(o){const r=o.response?.data?.code,_=r?C(r):e("roles.fetchFailed");v.error(_)}finally{E.value=!1}};return ce(()=>{g(),X(),R.connect(),R.on("deleteUserSuccess",()=>{h.value=!1,v.success(e("users.deleteSuccess")),g()}),R.on("deleteUserError",o=>{h.value=!1,v.error(e("users.deleteFailed")+`: ${C(o.code)}`),g()})}),ie(()=>{R.disconnect()}),(o,r)=>{const _=d("a-input-search"),m=d("a-select-option"),O=d("a-select"),S=d("a-button"),Y=d("a-spin"),Z=d("a-badge"),ee=d("a-tag"),ae=d("a-table"),N=d("a-input"),w=d("a-form-item"),se=d("a-input-password"),te=d("a-switch"),le=d("a-form"),re=d("a-modal");return F(),V("div",we,[p("div",Ce,[p("div",Ue,[t(_,{placeholder:s(e)("users.search"),class:"search-input",onSearch:H},null,8,["placeholder"]),p("div",xe,[p("div",Se,[p("span",ze,u(s(e)("users.sort")),1),t(O,{value:U.value,"onUpdate:value":r[0]||(r[0]=a=>U.value=a),class:"sort-select",style:{width:"120px"},onChange:$},{default:l(()=>[t(m,{value:"created_at"},{default:l(()=>[i(u(s(e)("users.createdAt")),1)]),_:1}),t(m,{value:"updated_at"},{default:l(()=>[i(u(s(e)("users.updatedAt")),1)]),_:1}),t(m,{value:"username"},{default:l(()=>[i(u(s(e)("users.username")),1)]),_:1}),t(m,{value:"email"},{default:l(()=>[i(u(s(e)("users.email")),1)]),_:1}),t(m,{value:"active"},{default:l(()=>[i(u(s(e)("users.status")),1)]),_:1}),t(m,{value:"image_count"},{default:l(()=>[i(u(s(e)("users.imageCount")),1)]),_:1})]),_:1},8,["value"]),t(O,{value:x.value,"onUpdate:value":r[1]||(r[1]=a=>x.value=a),class:"sort-select",style:{width:"80px"},onChange:$},{default:l(()=>[t(m,{value:"desc"},{default:l(()=>[i(u(s(e)("admin.albums.sortOptions.desc")),1)]),_:1}),t(m,{value:"asc"},{default:l(()=>[i(u(s(e)("admin.albums.sortOptions.asc")),1)]),_:1})]),_:1},8,["value"])]),t(S,{type:"text",onClick:J},{default:l(()=>[i(u(s(e)("users.resetFilters")),1)]),_:1}),t(S,{type:"primary",onClick:r[2]||(r[2]=a=>y.value=!0),class:"create-button"},{icon:l(()=>[t(s(me))]),default:l(()=>[i(" "+u(s(e)("users.createUser")),1)]),_:1})])]),h.value?(F(),V("div",Re,[t(Y,{size:"small"},{default:l(()=>[p("span",null,u(s(e)("users.deleting")),1)]),_:1})])):pe("",!0),t(ae,{columns:j,"data-source":D.value,loading:I.value,pagination:f.value,onChange:K,"row-key":"id"},{status:l(({record:a})=>[t(Z,{status:a.active?"success":"default",text:a.active?s(e)("users.active"):s(e)("users.inactive")},null,8,["status","text"])]),role:l(({record:a})=>[t(ee,null,{default:l(()=>[i(u(a.role.name),1)]),_:2},1024)]),total_size:l(({record:a})=>[p("span",null,u(s(T)(a.total_size))+" / "+u(a.role.max_storage_size_mb==-1?s(e)("dashboard.unlimited"):a.role.max_storage_size_mb+"MB"),1)]),created_at:l(({record:a})=>[p("span",null,u(s(P)(a.created_at)),1)]),updated_at:l(({record:a})=>[p("span",null,u(s(P)(a.updated_at)),1)]),actions:l(({record:a})=>[t(S,{type:"text",size:"small",onClick:oe=>Q(a)},{default:l(()=>[t(s(_e))]),_:1},8,["onClick"]),t(S,{type:"text",size:"small",danger:"",onClick:oe=>W(a.id)},{default:l(()=>[t(s(ve))]),_:1},8,["onClick"])]),_:1},8,["data-source","loading","pagination"]),p("div",Fe,[p("span",null,u(s(e)("users.totalStorageUsed"))+"："+u(s(T)(B.value)),1)])]),t(re,{open:y.value,"onUpdate:open":r[8]||(r[8]=a=>y.value=a),title:k.value?s(e)("users.edit"):s(e)("users.createUser"),onOk:G,onCancel:q},{default:l(()=>[t(le,{model:n,rules:L,ref_key:"userFormRef",ref:b},{default:l(()=>[t(w,{name:"username",label:s(e)("users.username")},{default:l(()=>[t(N,{value:n.username,"onUpdate:value":r[3]||(r[3]=a=>n.username=a),placeholder:s(e)("users.enterUsername")},null,8,["value","placeholder"])]),_:1},8,["label"]),t(w,{name:"email",label:s(e)("users.email")},{default:l(()=>[t(N,{value:n.email,"onUpdate:value":r[4]||(r[4]=a=>n.email=a),placeholder:s(e)("users.enterEmail")},null,8,["value","placeholder"])]),_:1},8,["label"]),t(w,{name:"password",label:s(e)("users.password")},{default:l(()=>[t(se,{value:n.password,"onUpdate:value":r[5]||(r[5]=a=>n.password=a),placeholder:s(e)("users.enterPassword")},null,8,["value","placeholder"])]),_:1},8,["label"]),t(w,{name:"role",label:s(e)("users.role")},{default:l(()=>[t(O,{value:n.role,"onUpdate:value":r[6]||(r[6]=a=>n.role=a),placeholder:s(e)("users.selectRole"),loading:E.value},{default:l(()=>[(F(!0),V(fe,null,ge(A.value,a=>(F(),be(m,{key:a.id,value:a.name},{default:l(()=>[i(u(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder","loading"])]),_:1},8,["label"]),t(w,{name:"active",label:s(e)("users.status")},{default:l(()=>[t(te,{checked:n.active,"onUpdate:checked":r[7]||(r[7]=a=>n.active=a)},null,8,["checked"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["open","title"])])}}}),$e=ke(Ie,[["__scopeId","data-v-85a6bb6a"]]);export{$e as default};
