import{d as $e,C as Ee,j as Ve,J as g,L as qe,c as f,a as u,l,x as n,s as O,i as s,E as v,t as d,k as U,F as j,r as K,S as Pe,q as Re,Q as de,R as ue,f as p,H as ae,e as je,I as h,o as c,y as ce,U as me,_ as Ke}from"./index-QwL2gIV2.js";import{b as ie,i as T}from"./services-DL6wjq8D.js";import{u as te}from"./websocket-BtUuRO1W.js";import{g as ge,f as Qe,a as He}from"./index-FacjB4mQ.js";import{g as C}from"./errorMessages-CmCcllaB.js";import{I as Je}from"./ImagePreviewModal-CzH7Dco5.js";import{S as We,B as Ge,M as Xe}from"./SelectOutlined-Cz4vkSq_.js";import{C as Ye,A as Ze}from"./CameraOutlined-B_uvHpuh.js";import{U as ea}from"./UploadOutlined-Bggr2RZO.js";import{L as aa}from"./LinkOutlined-CSKfWOCA.js";import"./axios-Cl3Sb8ms.js";const ta={class:"images-container"},la={class:"images-header card"},sa={class:"header-left"},oa={key:0,class:"header-selector"},na={class:"header-right"},ia={key:0,class:"deleting-status"},ra={class:"album-filter-container"},da={class:"search-container"},ua={key:0,class:"bottom-batch-actions"},ca={class:"bottom-batch-actions-content"},ma={class:"bottom-batch-actions-left"},ga={class:"bottom-selected-count"},pa={class:"bottom-batch-actions-right"},va={class:"images-main"},_a={key:0,class:"images-grid"},fa=["onClick"],ha={class:"image-container"},ba={class:"image-loader-container"},ya=["src","alt","onLoad","onError"],ka={key:0,class:"image-loader"},Aa={class:"image-info"},Ca={class:"image-filename"},Ia={class:"image-meta"},wa={class:"image-meta"},Sa={key:0,class:"image-tags"},Ua={key:1,class:"empty-state"},Ta={class:"empty-icon"},Fa={class:"empty-title"},Ma={class:"empty-description"},xa={key:2,class:"pagination-container"},Oa={class:"batch-add-info"},za={class:"batch-update-info"},Ba=$e({__name:"ImagesView",setup(Da){const{t}=Ee(),_=p([]),Q=p([]),m=p([]),H=p(!1),F=p(!1),k=p(1),M=p(20),J=p(0),D=p(""),W=p(!1),L=p(!1),N=p(!1),G=p(!1),le=p(null),I=p(!1),$=p(!1),E=p(!1),w=p(null),z=ae({album_id:""}),b=ae({original_name:"",tags:""}),V=p(""),se=p(),q=ae({album_id:""}),y=ae({original_name:"",tags:""}),pe={album_id:[{required:!0,message:()=>t("images.selectAlbum"),trigger:"blur"}]},oe=je({get:()=>_.value.length>0&&m.value.length===_.value.length,set:i=>{i?m.value=_.value.map(e=>e.id):m.value=[]}}),ve=i=>{le.value=i,G.value=!0},_e=()=>{G.value=!1,le.value=null},fe=()=>{I.value=!I.value,I.value||(m.value=[])},he=async i=>{try{if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(i),g.success(t("images.linkCopied"));else{const e=document.createElement("textarea");e.value=i,e.style.position="fixed",e.style.left="-9999px",e.style.top="0",document.body.appendChild(e),e.focus(),e.select();const o=document.execCommand("copy");document.body.removeChild(e),o?g.success(t("images.linkCopied")):g.error(t("images.copyLinkFailed"))}}catch{g.error(t("images.copyLinkFailed"))}},be=(i,e)=>{switch(w.value=e,i){case"update":b.original_name=e.original_name,b.tags=e.tags?.join(",")||"",$.value=!0;break;case"addToAlbum":E.value=!0;break;case"copyLink":const o=ge(e.file_url);he(o);break;case"delete":ye(e.id);break}},ye=i=>{me.confirm({title:t("images.confirmDelete"),content:t("images.deleteContent"),onOk:async()=>{try{F.value=!0,T.deleteUserImages([i]),g.warning(t("images.deleteStarted"))}catch(e){const o=e.response?.data?.code,r=o?C(o):t("images.deleteFailed");g.error(r),F.value=!1}}})},ke=async()=>{if(w.value)try{const e=Array.from(new Set(b.tags.split(","))).map(r=>r.trim()).filter(Boolean),o={ids:[w.value.id],tags:e};b.original_name.trim()&&(o.original_name=b.original_name.trim()),await T.updateUserImage(o),g.success(t("images.updateSuccess")),_.value=_.value.map(r=>{if(r.id===w.value?.id){const A={...r,tags:e};return b.original_name.trim()&&(A.original_name=b.original_name.trim()),A}return r}),$.value=!1,b.original_name="",b.tags="",w.value=null}catch(i){const e=i.response?.data?.code,o=e?C(e):t("images.updateFailed");g.error(o)}},Ae=async()=>{if(!(!w.value||!z.album_id))try{await T.addImagesToAlbum({album_id:parseInt(z.album_id.toString()),ids:[w.value.id]}),g.success(t("images.addToAlbumSuccess")),E.value=!1,z.album_id="",w.value=null}catch(i){const e=i.response?.data?.code,o=e?C(e):t("images.addToAlbumFailed");g.error(o)}},Ce=async()=>{try{const i=await ie.getUserAlbums({page:1,page_size:100});Q.value=i.data.albums}catch(i){const e=i.response?.data?.code,o=e?C(e):t("albums.fetchAlbumsFailed");g.error(o)}},x=async()=>{try{H.value=!0;const i=new Set(_.value?.map(r=>r.id)||[]);let e=[],o=0;if(V.value===""){const r=await T.getUserImages({page:k.value,page_size:M.value});e=r.data.images||[],o=r.data.total}else if(V.value==="-1"){const r=await ie.getImagesNotInAnyAlbum({page:k.value,page_size:M.value});e=r.data.images||[],o=r.data.total}else{const r=parseInt(V.value),A=await ie.getUserAlbumImages(r,{page:k.value,page_size:M.value});e=A.data.images||[],o=A.data.total}_.value=e.map(r=>({...r,loaded:i.has(r.id)})),J.value=o,m.value=[]}catch(i){const e=i.response?.data?.code,o=e?C(e):t("images.fetchImagesFailed");g.error(o)}finally{H.value=!1}},Ie=()=>{k.value=1,x()},we=(i,e)=>{e?m.value.push(i):m.value=m.value.filter(o=>o!==i)},Se=i=>{oe.value=i.target.checked},X=async()=>{if(!D.value.trim()){re();return}try{H.value=!0,W.value=!0,k.value=1;const i=new Set(_.value?.map(o=>o.id)||[]),e=await T.searchImages({search_key:D.value,page:k.value,page_size:M.value});_.value=e.data.images.map(o=>({...o,loaded:i.has(o.id)})),J.value=e.data.total,m.value=[]}catch(i){const e=i.response?.data?.code,o=e?C(e):t("images.searchFailed");g.error(o)}finally{H.value=!1}},re=()=>{D.value="",W.value=!1,k.value=1,x()},Ue=i=>{k.value=i,W.value?X():x()},Te=(i,e)=>{M.value=e,k.value=1,W.value?X():x()},Fe=()=>{m.value.length!==0&&me.confirm({title:t("images.confirmBatchDelete"),content:t("images.batchDeleteContent",{count:m.value.length}),onOk:async()=>{try{F.value=!0,T.deleteUserImages(m.value),g.warning(t("images.batchDeleteStarted")),m.value=[]}catch(i){const e=i.response?.data?.code,o=e?C(e):t("images.batchDeleteFailed");g.error(o),F.value=!1}}})},Me=async()=>{if(se.value)try{await se.value.validate(),await T.addImagesToAlbum({album_id:parseInt(q.album_id.toString()),ids:m.value}),g.success(t("images.batchAddToAlbumSuccess")),L.value=!1,q.album_id=""}catch(i){const e=i.response?.data?.code,o=e?C(e):t("images.batchAddToAlbumFailed");g.error(o)}},xe=async()=>{if(m.value.length)try{const e=Array.from(new Set(y.tags.split(","))).map(r=>r.trim()).filter(Boolean),o={ids:m.value,tags:e};y.original_name.trim()&&(o.original_name=y.original_name.trim()),await T.updateUserImage(o),g.success(t("images.batchUpdateSuccess")),_.value=_.value.map(r=>{if(m.value.includes(r.id)){const A={...r,tags:e};return y.original_name.trim()&&(A.original_name=y.original_name.trim()),A}return r}),N.value=!1,y.original_name="",y.tags=""}catch(i){const e=i.response?.data?.code,o=e?C(e):t("images.batchUpdateFailed");g.error(o)}};return Ve(()=>{x(),Ce(),te.connect(),te.on("deleteSuccess",()=>{F.value=!1,g.success(t("images.deleteSuccess")),x()}),te.on("deleteError",i=>{F.value=!1;const e=i.error?C(i.error):t("images.deleteFailed");g.error(e),x()})}),qe(()=>{te.disconnect()}),(i,e)=>{const o=h("a-button"),r=h("a-checkbox"),A=h("a-spin"),P=h("a-select-option"),ne=h("a-select"),R=h("a-input"),Y=h("a-menu-item"),Oe=h("a-menu"),ze=h("a-dropdown"),Be=h("a-tag"),De=h("router-link"),Le=h("a-pagination"),B=h("a-form-item"),Z=h("a-form"),ee=h("a-modal");return c(),f("div",ta,[u("header",la,[u("div",sa,[_.value!=null&&_.value.length>0?(c(),f("div",oa,[l(o,{type:I.value?"primary":"default",onClick:fe,class:"multi-select-button"},{default:n(()=>[I.value?(c(),O(s(We),{key:0})):(c(),O(s(Ge),{key:1}))]),_:1},8,["type"]),I.value?(c(),O(r,{key:0,checked:oe.value,"onUpdate:checked":e[0]||(e[0]=a=>oe.value=a),onChange:Se,class:"header-checkbox"},{default:n(()=>[v(d(s(t)("images.selectAll")),1)]),_:1},8,["checked"])):U("",!0)])):U("",!0)]),u("div",na,[F.value?(c(),f("div",ia,[l(A,{size:"small"},{default:n(()=>[u("span",null,d(s(t)("images.deleting")),1)]),_:1})])):U("",!0),u("div",ra,[l(ne,{value:V.value,"onUpdate:value":e[1]||(e[1]=a=>V.value=a),placeholder:s(t)("images.selectAlbum"),class:"album-filter-select",onChange:Ie},{default:n(()=>[l(P,{value:""},{default:n(()=>[v(d(s(t)("images.allImages")),1)]),_:1}),(c(!0),f(j,null,K(Q.value,a=>(c(),O(P,{key:a.id,value:a.id.toString()},{default:n(()=>[v(d(a.name),1)]),_:2},1032,["value"]))),128)),l(P,{value:"-1"},{default:n(()=>[v(d(s(t)("images.noAlbum")),1)]),_:1})]),_:1},8,["value","placeholder"])]),u("div",da,[l(R,{value:D.value,"onUpdate:value":e[2]||(e[2]=a=>D.value=a),placeholder:s(t)("images.search"),class:"search-input",onKeyup:Re(X,["enter"])},{prefix:n(()=>[l(s(Pe))]),_:1},8,["value","placeholder"]),l(o,{type:"default",onClick:X,class:"search-button"},{default:n(()=>[v(d(s(t)("images.searchButton")),1)]),_:1}),l(o,{type:"text",onClick:re,class:"reset-button"},{default:n(()=>[v(d(s(t)("images.resetButton")),1)]),_:1})])])]),m.value.length>0?(c(),f("div",ua,[u("div",ca,[u("div",ma,[u("span",ga,d(s(t)("images.selectedCount",{count:m.value.length})),1)]),u("div",pa,[l(o,{type:"default",onClick:e[3]||(e[3]=a=>N.value=!0),class:"bottom-batch-update-button"},{icon:n(()=>[l(s(de))]),default:n(()=>[v(" "+d(s(t)("images.batchUpdate")),1)]),_:1}),l(o,{type:"default",onClick:e[4]||(e[4]=a=>L.value=!0),class:"bottom-add-to-album-button"},{default:n(()=>[v(d(s(t)("images.addToAlbum")),1)]),_:1}),l(o,{type:"danger",onClick:Fe,class:"bottom-batch-delete-button"},{icon:n(()=>[l(s(ue))]),default:n(()=>[v(" "+d(s(t)("images.batchDelete")),1)]),_:1})])])])):U("",!0),u("main",va,[_.value!=null&&_.value.length>0?(c(),f("div",_a,[(c(!0),f(j,null,K(_.value,a=>(c(),f("div",{key:a.id,class:"image-card",onClick:S=>!I.value&&ve(a)},[u("div",ha,[I.value?(c(),f("div",{key:0,class:"image-checkbox",onClick:e[5]||(e[5]=ce(()=>{},["stop"]))},[l(r,{checked:m.value.includes(a.id),onChange:S=>we(a.id,S.target.checked)},null,8,["checked","onChange"])])):U("",!0),u("div",ba,[u("img",{src:s(ge)(a.thumbnail_url),alt:a.original_name,class:"image-preview",onLoad:S=>a.loaded=!0,onError:S=>a.loaded=!0},null,40,ya),a.loaded?U("",!0):(c(),f("div",ka,[...e[24]||(e[24]=[u("div",{class:"loader-spinner"},null,-1)])]))]),u("div",{class:"image-actions",onClick:e[6]||(e[6]=ce(()=>{},["stop"]))},[l(ze,null,{overlay:n(()=>[l(Oe,{onClick:S=>be(S.key,a)},{default:n(()=>[l(Y,{key:"update"},{icon:n(()=>[l(s(de))]),default:n(()=>[v(" "+d(s(t)("images.update")),1)]),_:1}),l(Y,{key:"addToAlbum"},{icon:n(()=>[l(s(Ze))]),default:n(()=>[v(" "+d(s(t)("images.addToAlbum")),1)]),_:1}),l(Y,{key:"copyLink"},{icon:n(()=>[l(s(aa))]),default:n(()=>[v(" "+d(s(t)("images.copyLink")),1)]),_:1}),l(Y,{key:"delete",danger:""},{icon:n(()=>[l(s(ue))]),default:n(()=>[v(" "+d(s(t)("images.delete")),1)]),_:1})]),_:1},8,["onClick"])]),default:n(()=>[l(o,{type:"text",class:"action-button"},{icon:n(()=>[l(s(Xe))]),_:1})]),_:2},1024)])]),u("div",Aa,[u("p",Ca,d(a.original_name),1),u("p",Ia,d(s(Qe)(a.file_size))+" • "+d(a.width)+" x "+d(a.height)+" • "+d(a.mime_type.split("/")[1]),1),u("p",wa,d(s(He)(a.created_at)),1),a.tags&&a.tags.length>0?(c(),f("div",Sa,[(c(!0),f(j,null,K(a.tags,(S,Ne)=>(c(),O(Be,{key:Ne,size:"small",color:"blue"},{default:n(()=>[v(d(S),1)]),_:2},1024))),128))])):U("",!0)])],8,fa))),128))])):(c(),f("div",Ua,[u("div",Ta,[l(s(Ye))]),u("h3",Fa,d(s(t)("images.noImages")),1),u("p",Ma,d(s(t)("images.goToUpload")),1),l(De,{to:"/manage/upload"},{default:n(()=>[l(o,{type:"primary",class:"empty-button"},{icon:n(()=>[l(s(ea))]),default:n(()=>[v(" "+d(s(t)("images.uploadImage")),1)]),_:1})]),_:1})])),J.value>0?(c(),f("div",xa,[l(Le,{current:k.value,"onUpdate:current":e[7]||(e[7]=a=>k.value=a),"page-size":M.value,"onUpdate:pageSize":e[8]||(e[8]=a=>M.value=a),total:J.value,"show-size-changer":!0,"page-size-options":["10","20","50","100"],onChange:Ue,onShowSizeChange:Te},null,8,["current","page-size","total"])])):U("",!0)]),l(Je,{visible:G.value,image:le.value,"onUpdate:visible":e[9]||(e[9]=a=>G.value=a),onClose:_e},null,8,["visible","image"]),l(ee,{open:L.value,"onUpdate:open":e[11]||(e[11]=a=>L.value=a),title:s(t)("images.batchAddToAlbum"),onOk:Me,onCancel:e[12]||(e[12]=a=>L.value=!1)},{default:n(()=>[l(Z,{model:q,rules:pe,ref_key:"batchAddFormRef",ref:se},{default:n(()=>[l(B,{name:"album_id",label:s(t)("images.selectAlbum")},{default:n(()=>[l(ne,{value:q.album_id,"onUpdate:value":e[10]||(e[10]=a=>q.album_id=a),placeholder:s(t)("images.selectAlbumPlaceholder")},{default:n(()=>[(c(!0),f(j,null,K(Q.value,a=>(c(),O(P,{key:a.id,value:a.id},{default:n(()=>[v(d(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"]),u("div",Oa,d(s(t)("images.addingToAlbum",{count:m.value.length})),1)]),_:1},8,["model"])]),_:1},8,["open","title"]),l(ee,{open:N.value,"onUpdate:open":e[15]||(e[15]=a=>N.value=a),title:s(t)("images.batchUpdate"),onOk:xe,onCancel:e[16]||(e[16]=a=>N.value=!1)},{default:n(()=>[l(Z,{model:y},{default:n(()=>[l(B,{label:s(t)("images.imageName")},{default:n(()=>[l(R,{value:y.original_name,"onUpdate:value":e[13]||(e[13]=a=>y.original_name=a),placeholder:s(t)("images.enterImageNameOptional")},null,8,["value","placeholder"])]),_:1},8,["label"]),l(B,{label:s(t)("images.tags")},{default:n(()=>[l(R,{value:y.tags,"onUpdate:value":e[14]||(e[14]=a=>y.tags=a),placeholder:s(t)("images.enterTagsOptional")},null,8,["value","placeholder"])]),_:1},8,["label"]),u("div",za,d(s(t)("images.updatingImages",{count:m.value.length})),1)]),_:1},8,["model"])]),_:1},8,["open","title"]),l(ee,{open:$.value,"onUpdate:open":e[19]||(e[19]=a=>$.value=a),title:s(t)("images.updateImage"),onOk:ke,onCancel:e[20]||(e[20]=a=>$.value=!1)},{default:n(()=>[l(Z,{model:b},{default:n(()=>[l(B,{label:s(t)("images.imageName")},{default:n(()=>[l(R,{value:b.original_name,"onUpdate:value":e[17]||(e[17]=a=>b.original_name=a),placeholder:s(t)("images.enterImageName")},null,8,["value","placeholder"])]),_:1},8,["label"]),l(B,{label:s(t)("images.tags")},{default:n(()=>[l(R,{value:b.tags,"onUpdate:value":e[18]||(e[18]=a=>b.tags=a),placeholder:s(t)("images.enterTagsOptional")},null,8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["open","title"]),l(ee,{open:E.value,"onUpdate:open":e[22]||(e[22]=a=>E.value=a),title:s(t)("images.addToAlbum"),onOk:Ae,onCancel:e[23]||(e[23]=a=>E.value=!1)},{default:n(()=>[l(Z,{model:z},{default:n(()=>[l(B,{label:s(t)("images.selectAlbum")},{default:n(()=>[l(ne,{value:z.album_id,"onUpdate:value":e[21]||(e[21]=a=>z.album_id=a),placeholder:s(t)("images.selectAlbumPlaceholder")},{default:n(()=>[(c(!0),f(j,null,K(Q.value,a=>(c(),O(P,{key:a.id,value:a.id},{default:n(()=>[v(d(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["open","title"])])}}}),Ha=Ke(Ba,[["__scopeId","data-v-d06e7346"]]);export{Ha as default};
