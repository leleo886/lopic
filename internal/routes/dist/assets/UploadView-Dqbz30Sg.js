import{u as re,b as ne,i as ie}from"./services-DL6wjq8D.js";import{u as n}from"./websocket-BtUuRO1W.js";import{g as U}from"./errorMessages-Bb-gZ73b.js";import{d as ce,C as ue,j as de,L as pe,c as b,a as o,t as l,i as t,l as u,x as p,E as w,B as _e,k as O,F as me,r as ge,f as x,H as R,e as S,J as d,I as m,o as f,s as fe,_ as ve}from"./index-DbrgNN6k.js";import{U as he}from"./UploadOutlined-B94lHz5_.js";import"./axios-Cl3Sb8ms.js";const be={class:"upload-container"},xe={class:"upload-header card"},ye={class:"upload-title"},Ce={class:"upload-description"},Ue={class:"upload-description"},Se={key:0,class:"upload-content"},Fe={class:"upload-main card"},we={class:"upload-section"},Ee={class:"section-title"},Ae={key:0,class:"upload-progress-section"},Pe={class:"section-title"},ze={class:"progress-container"},ke={class:"progress-header"},Me={class:"progress-file-name"},$e={class:"progress-bar-container"},Le={key:0,class:"progress-footer"},Be={class:"progress-error"},Ie={class:"upload-form"},Ne={class:"section-title"},Ve={class:"upload-actions"},je={class:"upload-limits card"},Te={class:"section-title"},qe={class:"limits-list"},De={class:"limit-item"},Oe={class:"limit-label"},Re={class:"limit-value"},We={class:"limit-item"},He={class:"limit-label"},Je={class:"limit-value"},Ge={class:"limit-item"},Ke={class:"limit-label"},Qe={class:"limit-value"},Xe={class:"limit-item"},Ye={class:"limit-label"},Ze={class:"limit-value"},es={class:"limit-item"},ss={class:"limit-label"},os={class:"limit-value"},as={key:1,class:"loading-container"},ts=ce({__name:"UploadView",setup(ls){const{t:s}=ue(),E=x(!0),v=x(null),z=x([]),_=x([]),F=x(!1),A=x(!1),a=R({progress:0,status:"uploading",error:"",fileCount:0}),c=R({tags:"",album_ids:[]}),W={tags:[],album_ids:[]},y=S(()=>v.value?.role.max_file_size_mb||10),C=S(()=>v.value?.role.max_files_per_upload||10),k=S(()=>v.value?.role.max_storage_size_mb||1024),M=S(()=>v.value?.role.max_albums_per_user||50),P=S(()=>v.value?.role.allowed_extensions||["jpg","jpeg","png","gif"]),H=async()=>{try{const e=await re.getCurrentUser();v.value=e.data}catch(e){const r=e.response?.data?.code,i=r?U(r):s("upload.fetchUserFailed");d.error(i)}},J=async()=>{try{const e=await ne.getUserAlbums({page:1,page_size:100});z.value=e.data.albums}catch(e){const r=e.response?.data?.code,i=r?U(r):s("upload.fetchAlbumsFailed");d.error(i)}},G=e=>{const i=e.name.toLowerCase().split(".").pop();return P.value.includes("."+i)?e.type.startsWith("image/")?!(e.size/1024/1024<y.value)&&y.value!==-1?(d.error(s("upload.fileSizeExceeded",{size:y.value})),!1):_.value.length>=C.value&&C.value!==-1?(d.error(s("upload.maxFilesExceeded",{count:C.value})),!1):(_.value=[..._.value,e],!1):(d.error(s("upload.onlyImagesAllowed")),!1):(d.error(s("upload.invalidFileExtension",{extensions:P.value.join(", ")})),!1)},K=e=>{const r=_.value.indexOf(e);r>-1&&_.value.splice(r,1)},Q=()=>{},X=async()=>{if(_.value.length===0){d.error(s("upload.selectFilesFirst"));return}try{F.value=!0,A.value=!0,a.progress=0,a.status="uploading",a.error="",a.fileCount=_.value.length;const e=new FormData;_.value.forEach(r=>{e.append("file",r)}),c.tags&&Array.from(new Set(c.tags.split(","))).map(h=>h.trim()).filter(Boolean).forEach(h=>{e.append("tags",h)}),c.album_ids&&c.album_ids.length>0&&c.album_ids.forEach(r=>{e.append("album_ids",r.toString())}),d.success(s("upload.uploadStarted")),await ie.uploadImages(e)}catch(e){const r=e.response?.data?.code,i=r?U(r):s("upload.uploadFailed");d.error(i),a.status="error",a.error=i}finally{F.value=!1}},Y=()=>{_.value=[],c.tags="",c.album_ids=[],A.value=!1,a.progress=0,a.status="uploading",a.error="",a.fileCount=0},$=e=>{},L=e=>{e.upload_id==="total"&&(a.progress=e.progress)},B=e=>{a.status="error",a.error=`${e.file_name}: ${e.error}`,d.error(`${s("upload.uploadFailed")}: ${e.file_name} - ${e.error}`)},I=e=>{a.progress=100,a.status="processing"},N=e=>{console.log(e.message),a.status="processing",a.progress=100},V=e=>{a.status="error",a.error=U(e.code),d.error(`${s("upload.processingFailed")}: ${U(e.code)}`)},j=e=>{a.status="completed",a.progress=100,d.success(`${s("upload.uploadSuccess")} (${e.file_count} ${s("upload.files")})`)},Z=e=>{switch(e){case"uploading":return"status-uploading";case"completed":return"status-completed";case"processing":return"status-processing";case"error":return"status-error";default:return""}},ee=e=>{switch(e){case"uploading":return s("upload.uploading");case"completed":return s("upload.completed");case"processing":return s("upload.processing");case"error":return s("upload.uploadFailed");default:return e}},se=e=>{switch(e){case"completed":return"success";case"error":return"exception";case"processing":return"active";default:return}};return de(async()=>{try{E.value=!0,await Promise.all([H(),J()]),n.on("start",$),n.on("progress",L),n.on("error",B),n.on("complete",I),n.on("processingStart",N),n.on("processingError",V),n.on("processingComplete",j),n.connect()}catch(e){console.error("Failed to initialize:",e)}finally{E.value=!1}}),pe(()=>{n.off("start",$),n.off("progress",L),n.off("error",B),n.off("complete",I),n.off("processingStart",N),n.off("processingError",V),n.off("processingComplete",j),n.disconnect()}),(e,r)=>{const i=m("a-button"),h=m("a-upload"),T=m("a-progress"),q=m("a-input"),D=m("a-form-item"),oe=m("a-select-option"),ae=m("a-select"),te=m("a-form"),le=m("a-spin");return f(),b("div",be,[o("div",xe,[o("h2",ye,l(t(s)("upload.title")),1),o("p",Ce,l(t(s)("upload.description")),1),o("p",Ue,l(t(s)("upload.multipleAlbums")),1)]),E.value?(f(),b("div",as,[u(le,{tip:t(s)("upload.loading")},{default:p(()=>[...r[2]||(r[2]=[o("div",{class:"loading-content"},null,-1)])]),_:1},8,["tip"])])):(f(),b("div",Se,[o("div",Fe,[o("div",we,[o("h3",Ee,l(t(s)("upload.selectFiles")),1),u(h,{action:"",multiple:!0,"custom-request":Q,"file-list":_.value,"before-upload":G,"on-remove":K,class:"upload-component"},{default:p(()=>[u(i,{type:"primary",class:"select-button"},{icon:p(()=>[u(t(he))]),default:p(()=>[w(" "+l(t(s)("upload.selectFiles")),1)]),_:1})]),_:1},8,["file-list"])]),A.value?(f(),b("div",Ae,[o("h3",Pe,l(t(s)("upload.uploadProgress")),1),o("div",ze,[o("div",ke,[o("span",Me,l(a.fileCount)+" "+l(t(s)("upload.files")),1),o("span",{class:_e(["progress-status",Z(a.status)])},l(ee(a.status)),3)]),o("div",$e,[u(T,{percent:Math.round(a.progress||0),status:se(a.status),format:()=>`${Math.round(a.progress||0)}%`},null,8,["percent","status","format"])]),a.error?(f(),b("div",Le,[o("span",Be,l(a.error),1)])):O("",!0)])])):O("",!0),o("div",Ie,[o("h3",Ne,l(t(s)("upload.uploadSettings")),1),u(te,{model:c,rules:W},{default:p(()=>[u(D,{label:t(s)("upload.tags")},{default:p(()=>[u(q,{value:c.tags,"onUpdate:value":r[0]||(r[0]=g=>c.tags=g),placeholder:t(s)("upload.enterTags")},null,8,["value","placeholder"])]),_:1},8,["label"]),u(D,{label:t(s)("upload.albums")},{default:p(()=>[u(ae,{value:c.album_ids,"onUpdate:value":r[1]||(r[1]=g=>c.album_ids=g),mode:"multiple",placeholder:t(s)("upload.selectAlbumsPlaceholder")},{default:p(()=>[(f(!0),b(me,null,ge(z.value,g=>(f(),fe(oe,{key:g.id,value:g.id},{default:p(()=>[w(l(g.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),o("div",Ve,[u(i,{type:"primary",onClick:X,class:"confirm-button",loading:F.value},{default:p(()=>[w(l(F.value?t(s)("upload.uploading"):t(s)("upload.confirmUpload")),1)]),_:1},8,["loading"]),u(i,{type:"default",onClick:Y,class:"reset-button"},{default:p(()=>[w(l(t(s)("upload.reset")),1)]),_:1})])]),o("div",je,[o("h3",Te,l(t(s)("upload.uploadLimits")),1),o("div",qe,[o("div",De,[o("span",Oe,l(t(s)("upload.maxFileSize"))+"：",1),o("span",Re,l(y.value==-1?t(s)("upload.unlimited"):y.value+"MB"),1)]),o("div",We,[o("span",He,l(t(s)("upload.filesPerUpload"))+"：",1),o("span",Je,l(C.value==-1?t(s)("upload.unlimited"):C.value),1)]),o("div",Ge,[o("span",Ke,l(t(s)("upload.storageLimit"))+"：",1),o("span",Qe,l(k.value==-1?t(s)("upload.unlimited"):k.value+"MB"),1)]),o("div",Xe,[o("span",Ye,l(t(s)("upload.albumsLimit"))+"：",1),o("span",Ze,l(M.value==-1?t(s)("upload.unlimited"):M.value),1)]),o("div",es,[o("span",ss,l(t(s)("upload.allowedExtensions"))+"：",1),o("span",os,l(P.value.join(", ")),1)])])])]))])}}}),ps=ve(ts,[["__scopeId","data-v-558f434a"]]);export{ps as default};
