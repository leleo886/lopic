import{c as v}from"./services-DL6wjq8D.js";import{g as y}from"./errorMessages-CmCcllaB.js";import{a as F,f as ee}from"./index-FacjB4mQ.js";import{d as ye,C as ve,w as he,j as Ce,L as we,c as C,a as k,t as n,i as r,l as i,x as o,E as d,B as Be,k as w,F as ae,s as I,H as te,f as m,J as p,U as $,I as _,o as b,_ as xe}from"./index-QwL2gIV2.js";import{u as M}from"./websocket-BtUuRO1W.js";import"./axios-Cl3Sb8ms.js";const Re={class:"backup-view"},Te={class:"backup-content card"},Se={class:"backup-header"},Fe={class:"backup-title"},Me={class:"backup-actions"},ze={key:0,class:"upload-progress-section"},De={class:"section-title"},Pe={class:"progress-container"},Ae={class:"progress-header"},Ie={class:"progress-file-name"},$e={class:"progress-bar-container"},Ue={key:0,class:"progress-footer"},Ee={class:"progress-error"},Ne={class:"tab-content"},Oe={key:0,class:"empty-state"},Ve={class:"tab-content"},Le=["onClick"],Ke={key:0,class:"empty-state"},je=ye({__name:"BackupView",setup(qe){const{t:e}=ve(),f=te({backups:!1,restores:!1}),U=m(!1),E=m(null),N=m(null),O=m(null),z=m(!1),V=m(!1),L=m("backups"),q=m(!1),u=te({progress:0,status:"uploading",error:"",fileName:""}),B=m([]),x=m([]),D=m(!1),g=m({id:0,status:"",size:0,created_at:"",updated_at:"",start_time:"",end_time:"",error:"",storage_path:""}),se=[{title:"ID",dataIndex:"id",key:"id",width:80},{title:e("admin.backup.status"),dataIndex:"status",key:"status"},{title:e("admin.backup.backupSize"),dataIndex:"size",key:"size",slots:{customRender:"size"}},{title:e("admin.backup.backupFile"),dataIndex:"storage_path",key:"storage_path"},{title:e("admin.backup.startTime"),dataIndex:"start_time",key:"start_time",slots:{customRender:"start_time"}},{title:e("admin.backup.endTime"),dataIndex:"end_time",key:"end_time",slots:{customRender:"end_time"}},{title:e("admin.backup.errorMessage"),dataIndex:"error",key:"error",slots:{customRender:"error"}},{title:e("admin.backup.actions"),key:"actions"}],re=[{title:"ID",dataIndex:"id",key:"id",width:80},{title:e("admin.backup.restoreSource"),dataIndex:"backup_task_id",key:"backup_task_id"},{title:e("admin.backup.status"),dataIndex:"status",key:"status"},{title:e("admin.backup.startTime"),dataIndex:"start_time",key:"start_time",slots:{customRender:"start_time"}},{title:e("admin.backup.endTime"),dataIndex:"end_time",key:"end_time",slots:{customRender:"end_time"}},{title:e("admin.backup.errorMessage"),dataIndex:"error",key:"error",slots:{customRender:"error"}},{title:e("admin.backup.actions"),key:"actions",fixed:"right"}],K=m(null),H=a=>{switch(a){case"completed":return"green";case"failed":return"red";case"pending":case"running":return"blue";default:return"default"}},j=a=>{switch(a){case"completed":return e("admin.backup.statusCompleted");case"failed":return e("admin.backup.statusFailed");case"pending":return e("admin.backup.statusPending");case"running":return e("admin.backup.statusRunning");default:return a}},oe=a=>{switch(a){case"uploading":return"status-uploading";case"completed":return"status-completed";case"error":return"status-error";default:return""}},ne=a=>{switch(a){case"uploading":return e("admin.backup.uploading");case"completed":return e("admin.backup.statusCompleted");case"error":return e("admin.backup.uploadFailed");default:return a}},ce=a=>{switch(a){case"completed":return"success";case"error":return"exception";default:return}},R=async()=>{try{f.backups=!0;const a=await v.getBackups();a.data&&Array.isArray(a.data)?B.value=a.data:a.data&&a.data.data&&Array.isArray(a.data.data)?B.value=a.data.data:B.value=[]}catch(a){const c=a.response?.data?.code,s=c?y(c):e("admin.backup.fetchBackupsFailed");p.error(s)}finally{f.backups=!1}},P=async()=>{try{f.restores=!0;const a=await v.getRestoreTasks();a.data&&Array.isArray(a.data)?x.value=a.data:a.data&&a.data.data&&Array.isArray(a.data.data)?x.value=a.data.data:x.value=[]}catch(a){const c=a.response?.data?.code,s=c?y(c):e("admin.backup.fetchRestoresFailed");p.error(s)}finally{f.restores=!1}},ie=async()=>{$.confirm({title:e("admin.backup.confirmCreateTitle"),content:e("admin.backup.confirmCreateContent"),okText:e("admin.backup.confirmCreate"),cancelText:e("admin.backup.cancel"),onOk:async()=>{try{U.value=!0,await v.createBackup(),p.success(e("admin.backup.createBackupStarted")),R()}catch(a){const c=a.response?.data?.code,s=c?y(c):e("admin.backup.createBackupFailed");p.error(s)}finally{U.value=!1}}})},de=a=>{$.confirm({title:e("admin.backup.confirmRestoreTitle"),content:e("admin.backup.confirmRestoreContent",{id:a}),okText:e("admin.backup.confirmRestore"),okType:"danger",cancelText:e("admin.backup.cancel"),onOk:async()=>{try{E.value=a,await v.restoreBackup(a),p.success(e("admin.backup.restoreStarted")),P()}catch(c){const s=c.response?.data?.code,l=s?y(s):e("admin.backup.restoreBackupFailed");p.error(l)}finally{E.value=null}}})},le=a=>{$.confirm({title:e("admin.backup.confirmDeleteTitle"),content:e("admin.backup.confirmDeleteContent",{id:a}),okText:e("admin.backup.confirmDelete"),okType:"danger",cancelText:e("admin.backup.cancel"),onOk:async()=>{try{N.value=a,await v.deleteBackup(a),p.success(e("admin.backup.deleteBackupSuccess")),R()}catch(c){const s=c.response?.data?.code,l=s?y(s):e("admin.backup.deleteBackupFailed");p.error(l)}finally{N.value=null}}})},ue=async a=>{try{O.value=a;const c=await v.downloadBackup(a),s=window.URL.createObjectURL(new Blob([c.data])),l=document.createElement("a");l.href=s;const T=new Date().getTime();l.setAttribute("download",`backup_${a}_${T}.zip`),document.body.appendChild(l),l.click(),document.body.removeChild(l),p.success(e("admin.backup.downloadBackupSuccess"))}catch(c){const s=c.response?.data?.code,l=s?y(s):e("admin.backup.downloadBackupFailed");p.error(l)}finally{O.value=null}},pe=async a=>{const{file:c}=a;try{z.value=!0,q.value=!0,u.progress=0,u.status="uploading",u.error="",u.fileName=c.name||e("admin.backup.backupFile");const s=new FormData;s.append("file",c),p.info(e("admin.backup.uploadStarted"));const l=await v.uploadBackup(s);a.onSuccess&&a.onSuccess(l)}catch(s){const l=s.response?.data?.code,T=l?y(l):e("admin.backup.uploadBackupFailed");p.error(T),u.status="error",u.error=T,a.onError&&a.onError(s)}finally{z.value=!1}},ke=async()=>{try{V.value=!0,await Promise.all([R(),P()]),p.success(e("admin.backup.refreshSuccess"))}catch(a){const c=a.response?.data?.code,s=c?y(c):e("admin.backup.refreshFailed");p.error(s)}finally{V.value=!1}},me=a=>{$.confirm({title:e("admin.backup.confirmDeleteTitle"),content:e("admin.backup.confirmDeleteRestoreContent",{id:a}),okText:e("admin.backup.confirmDelete"),okType:"danger",cancelText:e("admin.backup.cancel"),onOk:async()=>{try{K.value=a,await v.deleteRestoreTask(a),p.success(e("admin.backup.deleteRestoreSuccess")),P()}catch(c){const s=c.response?.data?.code,l=s?y(s):e("admin.backup.deleteRestoreFailed");p.error(l)}finally{K.value=null}}})},_e=a=>{a&&(g.value=a,D.value=!0)},J=()=>{D.value=!1,g.value={id:0,status:"",size:0,created_at:"",updated_at:"",start_time:"",end_time:"",error:"",storage_path:""}};he(L,a=>{a==="backups"&&B.value.length===0?R():a==="restores"&&x.value.length===0&&P()});const W=a=>{a.upload_id==="total"&&(u.progress=a.progress,a.progress>=100&&(u.status="completed",p.success(e("admin.backup.uploadBackupSuccess")),R()))},G=a=>{u.status="error",u.error=a.error,p.error(`${e("admin.backup.uploadFailed")}: ${a.error}`)};return Ce(()=>{R(),M.on("progress",W),M.on("error",G),M.connect()}),we(()=>{M.off("progress",W),M.off("error",G),M.disconnect()}),(a,c)=>{const s=_("a-button"),l=_("a-upload"),T=_("a-progress"),Q=_("a-tag"),X=_("a-table"),Y=_("a-spin"),Z=_("a-tab-pane"),be=_("a-tabs"),h=_("a-descriptions-item"),fe=_("a-descriptions"),ge=_("a-modal");return b(),C(ae,null,[k("div",Re,[k("div",Te,[k("div",Se,[k("h2",Fe,n(r(e)("admin.backup.title")),1),k("div",Me,[i(s,{type:"primary",onClick:ie,loading:U.value,class:"create-backup-button"},{default:o(()=>[d(n(r(e)("admin.backup.createBackup")),1)]),_:1},8,["loading"]),i(l,{"custom-request":pe,"show-upload-list":!1,accept:".zip",disabled:z.value},{default:o(()=>[i(s,{type:"default",loading:z.value,class:"upload-backup-button"},{default:o(()=>[d(n(r(e)("admin.backup.uploadBackup")),1)]),_:1},8,["loading"])]),_:1},8,["disabled"]),i(s,{type:"default",onClick:ke,loading:V.value,class:"refresh-backup-button"},{default:o(()=>[d(n(r(e)("admin.backup.refresh")),1)]),_:1},8,["loading"])])]),q.value?(b(),C("div",ze,[k("h3",De,n(r(e)("admin.backup.uploadProgress")),1),k("div",Pe,[k("div",Ae,[k("span",Ie,n(u.fileName||r(e)("admin.backup.backupFile")),1),k("span",{class:Be(["progress-status",oe(u.status)])},n(ne(u.status)),3)]),k("div",$e,[i(T,{percent:Math.round(u.progress||0),status:ce(u.status),format:()=>`${Math.round(u.progress||0)}%`},null,8,["percent","status","format"])]),u.error?(b(),C("div",Ue,[k("span",Ee,n(u.error),1)])):w("",!0)])])):w("",!0),i(be,{activeKey:L.value,"onUpdate:activeKey":c[0]||(c[0]=t=>L.value=t),type:"card",size:"large"},{default:o(()=>[i(Z,{key:"backups",tab:r(e)("admin.backup.backupRecords")},{default:o(()=>[k("div",Ne,[i(Y,{spinning:f.backups,tip:r(e)("admin.backup.loadingBackups")},{default:o(()=>[i(X,{columns:se,"data-source":B.value,"row-key":t=>t.id,pagination:!1,loading:f.backups},{size:o(({record:t})=>[d(n(r(ee)(t.size)),1)]),start_time:o(({record:t})=>[d(n(r(F)(t.start_time)),1)]),end_time:o(({record:t})=>[d(n(r(F)(t.end_time)),1)]),error:o(({record:t})=>[d(n(t.error||r(e)("admin.backup.none")),1)]),bodyCell:o(({record:t,column:S})=>[S.key==="actions"?(b(),C(ae,{key:0},[i(s,{type:"link",onClick:A=>ue(t.id),loading:O.value===t.id},{default:o(()=>[d(n(r(e)("admin.backup.download")),1)]),_:1},8,["onClick","loading"]),i(s,{type:"link",onClick:A=>de(t.id),loading:E.value===t.id},{default:o(()=>[d(n(r(e)("admin.backup.restore")),1)]),_:1},8,["onClick","loading"]),i(s,{type:"link",danger:"",onClick:A=>le(t.id),loading:N.value===t.id},{default:o(()=>[d(n(r(e)("admin.backup.delete")),1)]),_:1},8,["onClick","loading"])],64)):S.key==="status"?(b(),I(Q,{key:1,color:H(t.status)},{default:o(()=>[d(n(j(t.status)),1)]),_:2},1032,["color"])):w("",!0)]),_:1},8,["data-source","row-key","loading"]),B.value.length===0&&!f.backups?(b(),C("div",Oe,[k("p",null,n(r(e)("admin.backup.noBackupRecords")),1)])):w("",!0)]),_:1},8,["spinning","tip"])])]),_:1},8,["tab"]),i(Z,{key:"restores",tab:r(e)("admin.backup.restoreRecords")},{default:o(()=>[k("div",Ve,[i(Y,{spinning:f.restores,tip:r(e)("admin.backup.loadingRestores")},{default:o(()=>[i(X,{columns:re,"data-source":x.value,"row-key":t=>t.id,pagination:!1,loading:f.restores},{start_time:o(({record:t})=>[d(n(r(F)(t.start_time)),1)]),end_time:o(({record:t})=>[d(n(r(F)(t.end_time)),1)]),error:o(({record:t})=>[d(n(t.error||r(e)("admin.backup.none")),1)]),bodyCell:o(({record:t,column:S})=>[S.key==="status"?(b(),I(Q,{key:0,color:H(t.status)},{default:o(()=>[d(n(j(t.status)),1)]),_:2},1032,["color"])):S.key==="backup_task_id"?(b(),C("a",{key:1,onClick:A=>_e(t.backup_task)},n(t.backup_task_id),9,Le)):S.key==="actions"?(b(),I(s,{key:2,type:"link",danger:"",onClick:A=>me(t.id),loading:K.value===t.id},{default:o(()=>[d(n(r(e)("admin.backup.delete")),1)]),_:1},8,["onClick","loading"])):w("",!0)]),_:1},8,["data-source","row-key","loading"]),x.value.length===0&&!f.restores?(b(),C("div",Ke,[k("p",null,n(r(e)("admin.backup.noRestoreRecords")),1)])):w("",!0)]),_:1},8,["spinning","tip"])])]),_:1},8,["tab"])]),_:1},8,["activeKey"])])]),i(ge,{open:D.value,"onUpdate:open":c[1]||(c[1]=t=>D.value=t),title:r(e)("admin.backup.backupFile"),width:"50%",onCancel:J,onOk:J},{default:o(()=>[i(fe,{column:1,bordered:"",size:"small"},{default:o(()=>[i(h,{label:r(e)("admin.backup.backupId")},{default:o(()=>[d(n(g.value.id),1)]),_:1},8,["label"]),i(h,{label:r(e)("admin.backup.status")},{default:o(()=>[d(n(j(g.value.status)),1)]),_:1},8,["label"]),i(h,{label:r(e)("admin.backup.backupSize")},{default:o(()=>[d(n(r(ee)(g.value.size)),1)]),_:1},8,["label"]),i(h,{label:r(e)("admin.backup.storagePath")},{default:o(()=>[d(n(g.value.storage_path),1)]),_:1},8,["label"]),i(h,{label:r(e)("admin.backup.startTime")},{default:o(()=>[d(n(r(F)(g.value.start_time)),1)]),_:1},8,["label"]),i(h,{label:r(e)("admin.backup.endTime")},{default:o(()=>[d(n(r(F)(g.value.end_time)),1)]),_:1},8,["label"]),g.value.error?(b(),I(h,{key:0,label:r(e)("admin.backup.errorMessage")},{default:o(()=>[d(n(g.value.error),1)]),_:1},8,["label"])):w("",!0)]),_:1})]),_:1},8,["open","title"])],64)}}}),Ye=xe(je,[["__scopeId","data-v-2ede7221"]]);export{Ye as default};
